---
layout: post
title:  "NOTES: Detecting Network Abnormalities: Intermediate Network Traffic Analysis"
date: 2025-03-9
author: C. Casquatch
comments: false
tag: ['traffic analysis', 'networking', 'fragmentation', 'ip spoofing', 'ttl attacks', 'tcp handshake', 'tcp resets', 'tcp hijacking', icmp tunneling', 'htb']
---

Fragmentation Attacks
=====================

Related PCAP File(s):
---------------------

*   nmap\_frag\_fw\_bypass.pcapng

When investigating network anomalies, it's essential to look at the IP layer, which is responsible for transferring packets between network hops. This layer facilitates communication using source and destination IP addresses, allowing data to move from one host to another. By examining network traffic, we can view these IP addresses in the packet’s header.

However, it's important to understand that the IP layer lacks mechanisms to detect lost or corrupted packets. This responsibility falls to higher layers, such as the transport or application layer. To analyse these packets effectively, let’s break down some key fields:

1.  **Length** – This field specifies the length of the IP header.
2.  **Total Length** – This field indicates the entire length of the IP packet, including any data contained within.
3.  **Fragment Offset** – If a packet is too large, this field contains the position where a fragment fits into the original packet to help reassemble it once it reaches the destination host.
4.  **Source and Destination IP Addresses** – These fields contain the IP addresses of the source and destination hosts involved in the communication.

Commonly Abused Fields
----------------------

Attackers may exploit these fields to disrupt communications. By manipulating packets, attackers can evade intrusion detection systems (IDS) or other security controls. A deep understanding of these fields will help us recognise misuse and improve our traffic analysis capabilities.

### Fragmentation Abuse

Fragmentation allows legitimate hosts to send large amounts of data by splitting it into smaller packets, which are later reassembled at the receiving end. This is often controlled by a Maximum Transmission Unit (MTU) size. The MTU dictates how packets are divided, with the last packet often being smaller than the others. This allows the destination host to reassemble the full transmission.

However, attackers can abuse fragmentation for various malicious purposes:

*   **IDS/IPS Evasion** – If an IDS does not reassemble fragmented packets, an attacker can split their Nmap scan into fragmented packets to bypass detection. These will only be reassembled at the destination.
*   **Firewall Evasion** – Similar to IDS evasion, an attacker can fragment packets to bypass firewall controls. If the firewall doesn't reassemble the fragments, the attack might slip through.
*   **Resource Exhaustion** – If an attacker sends excessively small fragmented packets (such as with an MTU of 10, 15, or 20 bytes), it could overwhelm the network device, which might fail to reassemble these packets due to resource constraints. This could allow the attacker to bypass network controls.
*   **Denial of Service (DoS)** – For older or poorly configured hosts, fragmentation can be used to send oversized packets, exceeding the 65535-byte limit. When reassembled, these packets can cause system failures, leading to a DoS condition.

In a properly functioning network, the following should occur:

*   **Delayed Reassembly** – Firewalls, IDS/IPS systems should behave like the destination host, waiting until all fragments arrive before reconstructing the packet for inspection.

Detecting Fragment Offset Irregularities
----------------------------------------

To better understand the mechanics of fragmentation attacks, let’s open the relevant PCAP file in Wireshark:

    wireshark nmap_frag_fw_bypass.pcapng

Upon inspecting the traffic, we’ll notice ICMP requests being sent to one host, marking the initial phase of a typical Nmap scan. This is part of the host discovery process, where an attacker might execute a command like:

    nmap <host ip>

Following this, the attacker might specify a maximum transmission unit (MTU) size to fragment the packets generated by a port scan:

    nmap -f 10 <host ip>

This will cause the IP packets to be fragmented, each with a maximum size of 10 bytes. A large volume of fragmented packets from a host could indicate an attempted fragmentation attack. The packet flow might look like this:

The most significant indicator of a fragmentation scan, however, is the communication between a single host and many ports. In such cases, the destination host will respond with RST flags for closed ports (those without an active service). This creates a distinct pattern indicative of a fragmented scan.

If Wireshark is not reassembling packets for inspection, we can modify the preferences for the IPv4 protocol to enable this feature.

### QUESTION

#### Inspect the nmap_frag_fw_bypass.pcapng file, part of this module's resources, and enter the total count of packets that have the TCP RST flag set as your answer.
ANSWER:



IP Source & Destination Spoofing Attacks
========================================

When analysing network traffic, particularly with IPv4 and IPv6 packets, we often observe irregularities in the source and destination IP addresses. It's important to keep the following points in mind while analysing these fields:

1.  **Source IP Address for Incoming Traffic:** The source IP address should typically be from within your network's subnet. If an incoming packet has a source IP from outside your local area network (LAN), it could indicate that the packet has been crafted maliciously.
2.  **Source IP Address for Outgoing Traffic:** The source IP for outgoing packets should also match your network’s range. If it's from a different IP range, it could suggest that the malicious traffic originated from within your network.

Attackers may manipulate these source and destination IP fields for a variety of reasons, including:

*   **Decoy Scanning:** To avoid detection by firewalls, an attacker may alter the source IP address to make it appear as though the traffic is originating from a host within the same subnet as the target. This allows the attacker to bypass firewall rules that are designed to block traffic from unrecognised IP addresses.
*   **Random Source DDoS Attacks:** In these attacks, the attacker spoofs random source IP addresses, flooding the victim's network or host with traffic, leading to resource exhaustion or disruption of service.
*   **LAND Attacks:** These attacks involve setting the source and destination IP addresses to be the same, making the victim’s system process the traffic in a loop, which can lead to system crashes or resource exhaustion.
*   **SMURF Attacks:** Similar to LAND attacks, but with SMURF attacks, the attacker sends a large number of ICMP packets to multiple hosts, each with the source address set to the victim’s IP. This causes all the hosts to send ICMP replies to the victim, overwhelming its resources.
*   **Initialization Vector Generation:** In older wireless protocols like WEP, attackers might craft packets with specific source and destination IP addresses to generate predictable patterns, which can then be exploited to create a decryption table for later attacks.

While ARP poisoning attacks are similar, the ones discussed here occur at the IP layer and may often be combined with ARP poisoning for a more robust attack.

Finding Decoy Scanning Attempts
-------------------------------

**Related PCAP File(s):** decoy\_scanning\_nmap.pcapng

In cases where an attacker is trying to evade detection, they might change the source address to look like a legitimate host or a completely random address. This is a classic decoy scanning tactic, and it's not difficult to identify.

*   **Initial Fragmentation from an Inauthentic Address:** The attacker may initiate the scan using a fake source IP.
*   **Legitimate TCP Traffic:** Some traffic may appear from what seems like a legitimate source address.

In many cases, even though the attacker tries to obscure their true source, the RST flags from the closed ports are still sent back to the attacker, revealing the attacker's actual source.

Finding Random Source Attacks
-----------------------------

**Related PCAP File(s):** ICMP\_rand\_source.pcapng, ICMP\_rand\_source\_larg\_data.pcapng, TCP\_rand\_source\_attacks.pcapng

Random source attacks are a form of DDoS attack in which the attacker spoofs a wide range of source IP addresses. These attacks aim to overwhelm the victim's network or services, often by flooding a specific port.

*   **Targeting a Single Port with Random Sources:** Numerous packets from different, seemingly random sources will target the same service or port.
*   **Repetitive Base Port Numbers:** While the source IP addresses vary, the base port numbers may be incremented without much randomisation.
*   **Consistent Packet Lengths:** In normal traffic, packet lengths tend to vary. Identical packet lengths could be a sign of an attack.

Finding SMURF Attacks
---------------------

SMURF attacks are a type of distributed denial-of-service (DDoS) attack where the attacker sends ICMP requests to multiple hosts, all spoofed with the victim’s IP address. The result is that all hosts send ICMP replies to the victim, which can overwhelm their resources.

To spot a SMURF attack, look for:

*   **Excessive ICMP Replies from Multiple Hosts:** If many hosts are responding to a single victim with ICMP replies, this could be a sign of a SMURF attack.
*   **Fragmentation and Increased Traffic Volume:** Attackers may fragment the ICMP requests and inject data to increase the volume of traffic.

Finding LAND Attacks
--------------------

**Related PCAP File(s):** LAND-DoS.pcapng

LAND attacks involve the attacker spoofing their IP address to match the victim’s destination IP. This causes the victim’s system to process the traffic in a loop, which can cause it to crash or slow down significantly due to resource exhaustion.

*   **Source and Destination IPs are Identical:** If the source IP is the same as the destination IP, it's a clear indicator of a potential LAND attack.
*   **Excessive Traffic to a Single Port:** The attacker may flood a particular port, occupying the victim’s resources and making it difficult for legitimate connections to be established.

### QUESTION

#### Inspect the ICMP_smurf.pcapng file, part of this module's resources, and enter the total number of attacking hosts as your answer.
ANSWER:




IP Time-to-Live (TTL) Attacks
=============================

**Related PCAP File(s):**  
• ip\_ttl.pcapng

* * *

Time-to-Live (TTL) attacks are commonly used by attackers as a means to bypass detection systems like firewalls, IDS (Intrusion Detection Systems), and IPS (Intrusion Prevention Systems). Here’s how the attack generally works:

1.  The attacker creates an IP packet with an abnormally low TTL value (typically 1, 2, or 3).
2.  As the packet travels through each router or host in the network, the TTL value is reduced by one.
3.  Once the TTL hits zero, the packet is discarded. The attacker attempts to have the packet discarded before it reaches any security devices, thereby avoiding detection and filtering.
4.  When the TTL expires, routers along the way send ICMP "Time Exceeded" messages back to the original source address.

Detecting Irregularities in IP TTL
----------------------------------

To start, you can capture your traffic and open it in Wireshark. It may be hard to spot small instances of TTL manipulation, but attackers tend to use TTL adjustments in port scanning attempts, making it easier to detect. Upon inspection, you may notice the following signs:

*   A SYN/ACK message returned from a legitimate port on your target host, which might suggest that the attacker has successfully bypassed a firewall.

If you drill down into one of these suspicious packets in Wireshark (specifically the IPv4 section), you'll often see an unusually low TTL value, like 1 or 2. This confirms that TTL manipulation was used as part of the attack.

Mitigating TTL-Based Attacks
----------------------------

To protect against this form of attack, consider implementing network controls that filter out packets with too low a TTL value. By doing so, you can block IP packets that are crafted with the intention of bypassing your security systems.



TCP Handshake Abnormalities
===========================

When analysing network traffic, especially in TCP-based services, it's crucial to look out for unusual behaviour that may suggest an attack. The normal TCP connection process, known as the three-way handshake, involves a series of steps to establish a secure connection between two devices. Let’s first review the expected process and then explore the irregularities we might spot.

How the Normal TCP Handshake Works
----------------------------------

*   **SYN**: The client initiates a TCP connection by sending a SYN packet to the server, requesting a connection.
*   **SYN/ACK**: If the server is willing to accept the connection, it replies with a SYN/ACK packet, acknowledging the request.
*   **ACK**: The client then sends an ACK packet back to confirm the server's response, and the connection is established.

### Flags in TCP

*   **URG (Urgent)**: Marks the packet as urgent.
*   **ACK (Acknowledgement)**: Confirms that the data has been received.
*   **PSH (Push)**: Instructs the TCP stack to immediately send data to the application layer.
*   **RST (Reset)**: Terminates the connection.
*   **SYN (Synchronise)**: Used to start the connection.
*   **FIN (Finish)**: Marks the end of a connection.
*   **ECN (Explicit Congestion Notification)**: Used to inform hosts of network congestion.

Identifying Abnormal Traffic Patterns
-------------------------------------

When performing traffic analysis, you may observe unusual patterns in the flags or the way packets are transmitted. Some indicators to watch for include:

*   Too Many Identical Flags: An excessive number of the same flag, such as many SYN packets, can indicate scanning attempts.
*   Unusual Flag Combinations: Certain flag combinations may suggest an attack such as TCP RST (Reset) or attempts at evading controls.
*   Solo Host to Multiple Ports/Hosts: This could indicate port scanning or reconnaissance activity.

Excessive SYN Flags
-------------------

**Related PCAP Files:**  
nmap\_syn\_scan.pcapng

One common traffic anomaly is a high volume of SYN flags, which is typical of network scanning, particularly when using tools like Nmap. The scan involves sending a SYN packet to a target port. If the port is open, the server responds with a SYN/ACK packet, but before the handshake completes, the attacker sends an RST packet to abort the connection.

The two main types of SYN-based scans to look out for are:

*   **SYN Scans**: The attacker sends SYN packets and finishes the handshake with an RST.
*   **SYN Stealth Scans**: The attacker only completes part of the handshake to avoid detection.

No Flags (NULL Scan)
--------------------

**Related PCAP Files:**  
nmap\_null\_scan.pcapng

A NULL scan involves sending TCP packets without any flags set. This type of scan works as follows:

*   **Open Port**: No response is sent from the target as no flags are present.
*   **Closed Port**: The server responds with an RST packet, indicating the port is closed.

Excessive ACK Flags
-------------------

**Related PCAP Files:**  
nmap\_ack\_scan.pcapng

Excessive ACK flags in traffic might indicate an **ACK scan**, where the attacker is probing ports without completing a normal handshake. Here's how the affected host will respond:

*   **Open Port**: The target machine might not respond or send an RST.
*   **Closed Port**: An RST packet will be sent, indicating that the port is closed.

Excessive FIN Flags
-------------------

**Related PCAP Files:**  
nmap\_fin\_scan.pcapng

A **FIN scan** uses the FIN flag to check the status of ports. The response from the target will be:

*   **Open Port**: The machine will not respond.
*   **Closed Port**: An RST packet is sent.

Xmas Tree Scan
--------------

**Related PCAP Files:**  
nmap\_xmas\_scan.pcapng

The **Xmas Tree scan** involves sending a TCP packet with all the flags set, including SYN

### QUESTION

#### Inspect the nmap_syn_scan.pcapng file, part of this module's resources, and enter the total count of packets that have the TCP ACK flag set as your answer.
ANSWER: 




TCP Connection Resets & Hijacking
=================================

TCP connections, while fundamental to communication on the network, unfortunately lack the kind of security to stop attackers from terminating connections or hijacking them altogether. In certain scenarios, you might notice that a connection has been unexpectedly terminated by a TCP RST (Reset) packet or, in more severe cases, hijacked by an attacker.

TCP Connection Termination
--------------------------

**Related PCAP File(s):**  
_RST\_Attack.pcapng_

When an adversary attempts to disrupt the normal communication between two hosts, they might employ a TCP RST packet injection attack. In simple terms, this means forcibly terminating an active connection using a specially crafted RST packet. Here's how the attack works:

1.  **Spoofing the Source Address**: The attacker will impersonate the target machine by using its IP address as the source address in the attack packet.
2.  **Sending the RST Packet**: The attacker will set the RST flag in the TCP packet, instructing the recipient to terminate the connection.
3.  **Targeting a Specific Port**: The attacker will ensure the destination port of the packet matches a port currently in use by the target machine.

This kind of attack often results in the sudden and unexplained termination of connections. One way to confirm whether you’re dealing with an RST attack is by checking the MAC address of the device sending the malicious RST packets. If, for instance, the source address of the packet claims to be `192.168.10.4` but the physical MAC address doesn’t match what’s expected, this indicates malicious activity.

While this can be a reliable sign, be aware that attackers can also spoof their MAC addresses, making it harder to pinpoint them. In these cases, looking out for retransmissions or irregular traffic patterns could also provide clues, similar to what we observed with ARP poisoning.

TCP Connection Hijacking
------------------------

**Related PCAP File(s):**  
_TCP-hijacking.pcap_

For more advanced attacks, an adversary may seek to hijack an existing TCP connection. Unlike a simple termination, hijacking involves actively taking over a live communication session between two hosts. Here's how an attacker would execute this:

1.  **Monitoring the Connection**: The attacker continuously monitors the target TCP connection to gain insights into the session.
2.  **Predicting Sequence Numbers**: The attacker will try to predict the sequence numbers of the target connection to inject malicious packets into the communication stream in the correct order.
3.  **Spoofing the Source Address**: During the hijacking process, the attacker will impersonate the affected host by using its IP address as the source.
4.  **Blocking ACK Packets**: To ensure the hijacking goes undetected, the attacker might block or delay the delivery of ACK packets from the victim, allowing the hijacking process to continue without interference.

In many cases, this form of attack is used in conjunction with ARP poisoning, where the attacker manipulates the network to gain control over the communication flow. As a result, you may notice unexpected behaviours in your traffic analysis, such as interruptions in the normal flow of TCP connections.


### QUESTION

#### Inspect the TCP-hijacking.pcap file, part of this module's resources, and enter the username that has been used through the telnet protocol as your answer.
ANSWER:




ICMP Tunnelling
===============

**Related PCAP File(s):**

*   icmp\_tunneling.pcapng

What is Tunnelling?
-------------------

Tunnelling is a technique used by attackers to secretly send data from one point to another, often bypassing network security measures. There are multiple types of tunnelling, each using a different protocol. Often, attackers use proxies or protocols that are already allowed by our network controls to evade detection.

### Basics of Tunnelling

At its core, tunnelling is a method through which an attacker transmits data to a remote host, bypassing traditional network security controls. A common technique for this is SSH tunnelling, but it can also be performed using proxies, HTTP, HTTPS, DNS, or other protocols. The idea is to create a covert communication channel over an allowed protocol, which allows the attacker to maintain command and control and avoid detection by network defences.

ICMP Tunnelling
---------------

In ICMP tunnelling, the attacker inserts data into the payload of an ICMP request. The goal is to hide this data within an ICMP packet, which is a commonly allowed protocol, so that it blends in with regular network traffic. This enables the attacker to covertly exfiltrate data from the target network.

### Detecting ICMP Tunnelling

To detect ICMP tunnelling, we need to examine the contents of the data in ICMP requests and replies. You can filter the Wireshark capture for ICMP traffic by typing "ICMP" into the filter bar.

A key indicator of tunnelling is the presence of fragmented ICMP traffic, which suggests a large volume of data being transferred. For example, while a normal ICMP request might be around 48 bytes, suspicious traffic could have a data length of 38,000 bytes.

To investigate further, you can look at the data in transit. For example, if you spot a username and password being sent in an ICMP request to an external or internal host, that is a clear indication of tunnelling.

In some cases, more advanced attackers may encode or encrypt the data to make detection more difficult. If you encounter an encoded value in the data, you can decode it using tools like `base64` on Linux. For example:

    echo 'VGhpcyBpcyBhIHNlY3VyZSBrZXk6IEtleTEyMzQ1Njc4OQo=' | base64 -d

If the decoded result reveals something like sensitive information, it's a strong indication of ICMP tunnelling.

Preventing ICMP Tunnelling
--------------------------

To prevent ICMP tunnelling, you can implement the following measures:

1.  **Block ICMP Requests** - If ICMP traffic is blocked entirely, attackers won't be able to use it for tunnelling.
2.  **Inspect ICMP Requests and Replies for Data** - By examining ICMP traffic for unusual data or malicious content, you can gain better visibility into your network and prevent data exfiltration attempts.

### QUESTION

#### Enter the decoded value of the base64-encoded string that was mentioned in this section as your answer.
ANSWER:


<button onclick="history.back()">Go Back</button>
