---
layout: post
title:  "DCSync: Windows Attacks & Defense"
date: 2025-03-4
author: C. Casquatch
comments: false
tag: ['windows', 'DCSync', 'htb']
---

  DCSync Attack Walkthrough

DCSync Attack Walkthrough
=========================

Description
-----------

The DCSync attack is a method used by attackers to simulate the behavior of a Domain Controller and replicate with a targeted Domain Controller in order to extract password hashes from Active Directory. To execute this attack, the attacker needs the proper permissions, which include:

*   Replicating Directory Changes
*   Replicating Directory Changes All

These permissions are typically assigned to certain users or computers, allowing them to interact with the replication process within the Active Directory environment.

Attack
------

In this demonstration, we'll use the user account **Rocky**, whose password is **Slavi123**, to showcase the DCSync attack. First, we need to verify that Rocky has the necessary permissions.

_Screenshot 1: Display of Rocky's permissions (Replicating Directory Changes and Replicating Directory Changes All)._

Next, we’ll open a command shell running as Rocky. You can do this by executing the following:

    `[Your command for running as Rocky]`
    
    

Once we have the command shell, we’ll use Mimikatz, a tool that includes an implementation for performing the DCSync attack. To obtain the password hash for the user **Administrator**, we can execute the following command:

    `mimikatz # dcsync /user:Administrator`
    
    

If you want to dump the hashes of all users in the Active Directory environment, you can use the /all parameter instead of specifying a specific user:

    `mimikatz # dcsync /all`
    
    

Once the hashes are obtained, attackers can use them to perform pass-the-hash attacks against Domain Controllers.

_Screenshot 2: Command output from Mimikatz showing the password hash for the user Administrator._

Prevention
----------

Since the DCSync attack exploits a common operation in Active Directory—replication between Domain Controllers—it cannot be fully prevented. However, you can mitigate the risk by using solutions like the **RPC Firewall**. This tool allows you to block or allow specific RPC calls with granularity, such as permitting replication only from Domain Controllers.

_Screenshot 3: RPC Firewall configuration example (blocking replication requests from unauthorized systems)._

Detection
---------

Detecting the DCSync attack is fairly straightforward since every Domain Controller replication generates an event with ID 4662. By monitoring for this event and checking whether the initiator account is a Domain Controller, we can identify replication attempts that may be malicious.

_Screenshot 4: Example of Event ID 4662 indicating replication initiated by a user account._

To avoid false positives, consider the following:

*   Ensure the presence of property `1131f6aa-9c07-11d1-f79f-00c04fc2dcd2` or `1131f6ad-9c07-11d1-f79f-00c04fc2dcd2` in the event.
*   Whitelist systems/accounts that have a valid business reason for replication, such as **Azure AD Connect**, which replicates Domain Controller data to Azure AD.

Resources
---------

*   [RPC Firewall - ZeroNetworks](https://zeronetworks.com/rpcfirewall)
*   [\[MS-ADTS\]: Control Access Rights | Microsoft Learn](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/62f6ef7d-bd9c-4716-9fe4-71c82d6c8eab)


### QUESTIONS

#### Connect to the target and perform a DCSync attack as the user rocky (password:Slavi123). What is the NTLM hash of the Administrator user?
ANSWER:

#### After performing the DCSync attack, connect to DC1 as 'htb-student:HTB_@cademy_stdnt!' and look at the logs in Event Viewer. What is the Task Category of the events generated by the attack?
ANSWER:



<button onclick="history.back()">Go Back</button>
